---
title: "Bullying Network"
author: "Aurora Maria Tumminello, Lucia Hrovatin"
output:
  html_document:
    toc: yes
    df_print: paged
  html_notebook:
    toc: yes
    highlight: monochrome
    theme: journal
---

# Importing data

## Data Structure

The original dataset `bullying_network.xlsx` is an Excel file that contains two sheets about bullying within a group of 25 students in an Italian school class: the first one contains three attributes per student; the second one represents the adjacency matrix of a directed network depicting who bullies whom among the students. 

The first sheet, the attributes one, contains:

- **gender**, mapped in females (0) and males (1);
- **grade**, which goes from 0 to 10;
- **ethnicity**, divided into three categories: first-generation immigrants (born abroad with foreign parents), second-generation immigrants (born in Italy with foreign parents) and Italians (born in Italy with at least one Italian parent).

## Data pre-processing

As forehead described, the original Excel file contains two sheets. To retrieve the information there stored, a first approach exploited the `read_excel(path, sheet)` function and saved the two sheets in different variables. Since this attempt implied a network misreading of 0s and 1s as characters instead of double and creating an undirected graph, we opted for another importing action: the original Excel file has been manually split into two separate csv files:

- `bullying_attributes.csv`: containing the attributes of students inside the network;
- `bullying_network.csv`: containing the actual adjacency matrix (i.e. the network).

## Libraries

```{r message=FALSE}
library(tidyverse)
library(sna)
library(itsadug) # For gradient legend
library(knitr)
```

## Data import

### Import network data

With the following code, the network is imported, converted into matrix and then into directed network.

```{r}
# Importing data
net = as.matrix(read.csv("bullying_network.csv",
                         stringsAsFactors=FALSE, row.names=1))
# Converting the adjacency matrix to a network
net = as.network(net, directed=T)
# Inspect the network
summary(net, print.adj = FALSE)
```

By inspecting the obtained network through `summary(net)`, we may notice:

- the number of vertices (i.e., nodes), which are 25 students;
- that the network is directed;
- that no hyperedges, loops or multiple edges are allowed;
- that there are overall 76 directed edges;
- that the density is 0.1266667, which will be the focus of the centralisation section;
- that nodes are labeled with names, namely the studentsâ€™ first names.

### Import attributes

Students attributes have been saved in a distinct file and, therefore, imported separately. 

```{r}
# Reading the csv file with node attributes
attr = read.csv("bullying_attributes.csv")
```


# Drawing a network

## Basic Draw

<aside>
ðŸ’¡ *Draw the network using the Fruchterman-Reingold layout with names (but without attributes).*
</aside>

```{r}
par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
			mode="fruchtermanreingold", # set mode as Fruchterman-Reingold
      jitter=F,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col="cornflowerblue",   # set color of nodes
			vertex.sides = 100,
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7,       # indicate the size of the labels (1 is default)
			arrowhead.cex = 0.4,
			object.scale = 0.01)
```

The *Fruchterman-Reingold* layout is the default mode of the `gplot()` function and therefore it is not necessary to include it. Overall there are 25 labelled nodes connected through directed links which represent who bullies whom. In particular, there is a student, Roberto, that does not present incoming or outgoing edges and, following the definition of Wasserman & Faust (1994), it is defined as an isolate^[Wasserman, S., & Faust, K. (1994). Social network analysis: Methods and applications]. Therefore, Roberto is the only student in this specific school class that is not bullied and does not bully either.  


## Attribute-based network

<aside>
ðŸ’¡ *Next, draw the network again using the Fruchterman-Reingold layout without names, but now with all 3 attributes (gender, grade and ethnicity) included using in some way a combination of colour, shape and size of nodes.*

</aside>

<aside>
ðŸ’¡ *Create a legend for the attributes (this does not have to be with R, but needs to clarify how the different attributes were represented in the network).*

</aside>

Once again, letâ€™s consider the three attributes and their respective values:

- **Gender**: binomial variable 0/1;
- **Ethnicity**: categorical variable assuming three different values (1, 2 or 3);
- **Grade**: categorical variable assuming 11 different values (from 0 to 10).

These attributes could be mapped in many different ways considering the shape, the colour and the size of nodes. 

### First version

A first version considers:

- **size**: grade;
- **shape**: gender;
- **colour**: ethnicity.

```{r}

colours_1 = c("#2a9d8f", "#e9c46a", "#e76f51")
sizes = seq(0.1, 4, length.out=11)

par(mar=c(0,0,0,0))
gplot(net,
      gmode="digraph",    # directed network
      jitter=T,
      edge.col="grey70",  # set color of ties
      vertex.col=colours_1[attr$Ethnicity], # set color of nodes depending on ethnicity
      vertex.cex = sizes[attr$Grade], # set size of nodes depending on grade
      vertex.sides= (attr$Gender-1)*47+4, # set shape of nodes depending on gender
			vertex.rot = 45, # Nodes rotation
      arrowhead.cex = 0.5) # Size of the arrows head
```

In this representation, both gender and ethnicity are evident, while the grade is not accurately represented by the size. In this last case, the logarithm has been applied to the grade attribute in order to represent nodes properly and scale them, but still without being able to distinguish the difference in terms of grades.

In the following chunk, a legend is added to guide the user in the reading of the network:

- ethnicity, through colours, represents 1st and2nd generation of immigrants, plus the Italians;
- shapes map the gender of students: circles for males and squares for females;
- grades vary in terms of size, whose proportion is depicted in the legend, despite is not exactly the same represented in the network.

```{r}
sizes = seq(0.2, 3, length.out=11)

par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=T,           
      edge.col="grey70",  # set color of ties
      vertex.col=colours_1[attr$Ethnicity],   # set color of nodes depending on ethnicity 
      vertex.cex = sizes[attr$Grade], # set size of nodes depending on grade
      vertex.sides= (attr$Gender-1)*47+4, # set shape of nodes depending on gender  
      vertex.rot = 45,
      arrowhead.cex = 0.5,
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default)

legend("topleft",
       legend = c("Ethnicity"," 1st gen immigrants", " 2st gen immigrants", " Italian",
                  " ", "Gender", " Male", " Female",
                  " ", "Grade", 0:10),
       col = c("white",colours_1[1],colours_1[2],colours_1[3],
               "white","white","black","black",
               "white", "white", rep("black",11)), 
       bty = "n", 
       pch =c(15,15,15,15,
              15,15,19,15,
              15,15,rep(19,11)),
       pt.cex = c(0,2.1,2.1, 2.1,
                  0,0,2.1,2.1,
                  0, 0, (0:10)/5), 
       cex = 1, 
       text.col = "grey10", 
       horiz = F , 
       inset = c(0.01))
```

### Second version

A second approach is to represent attributes as such:

- shape: ethnicity (i.e. first-generation as triangles, second-generation as squares and Italians as circles);
- hue: gender (i.e. females as red, males as green);
- colour lightness: grade (the darker the higher, the lighter the lower).

```{r}

colours_2 = c('#fff0f3', '#ffccd5', '#ffb3c1', '#ff8fa3', '#ff758f', 
           '#ff4d6d', '#c9184a', '#a4133c', '#800f2f', '#590d22',
           "#d8f3dc","#b7e4c7","#95d5b2","#74c69d","#52b788",
           "#40916c", "#2d6a4f","#245741","#1b4332","#081c15"
)

shapes = c(3,4,50)

par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=F,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col=colours_2[attr$Gender*10+attr$Grade+1],   # set color of nodes
      vertex.cex = 1.3,
      vertex.rot = 45,
      vertex.sides= shapes[attr$Ethnicity],
      arrowhead.cex = 0.5)
```

Despite ethnicity is not so evident as before, in this case, gender is discernible through the hue of nodes and grade through the use of lightness in the choice of colours. In fact, darker colours indicate higher grades and the difference is perceptible with respect to the previous case where size was used. 

Notice that the application of size variation with respect to gender or ethnicity may unconsciously suggest a social superiority of one of the categories, which does not exist. Moreover, colours and shapes are sufficient to represent categorical variables with less than 3 values.

In this case, the legend shows:

- ethnicity as one of the shapes;
- gender as one of the two colours;
- grade as a gradient, varying between males and females, whose lightness relies on the studentsâ€™ grade.

This solution may help to understand the grade distribution among students, but still, the exact grade is difficult to get.

```{r}
par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=T,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col=colours_2[attr$Gender*10+attr$Grade+1],   # set color of nodes
      vertex.cex = 1,
      vertex.rot = 45,
      vertex.sides= shapes[attr$Ethnicity],
      displaylabels=T,    # indicate that labels should be included
      arrowhead.cex = 0.5,
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default))

# Legend for gender and ethnicity
legend("topleft",
       legend = c("Ethnicity"," 1st gen immigrants", " 2st gen immigrants", " Italian",
                  " ", "Gender", " Male", " Female",
                  " ", "Grade"),
       col = c("white","black","black", "black",
               "white","white","#52b788","#ff4d6d",
               "white", "white"), 
       bty = "n", 
       pch =c(15,17,15,19,
              15,15,15,15,
              15, 15),
       pt.cex = c(0,2.1,2.1, 2.2,
                  0,0,2.1,2.1,
                  0,0), 
       cex = 1, 
       text.col = "grey10", 
       horiz = F , 
       inset = c(0.01))

# Gradient legend
pal = colorRampPalette(colours_2[1:10])
gradientLegend(valRange=c(0,10), 
               color = pal(10),
               pos=c(0.05,0.1,.08,0.5), 
               side=4, 
               n.seg=1,
               border.col = "grey10",
               inside = T)

pal = colorRampPalette(colours_2[11:20])
gradientLegend(valRange=c(0,10), 
               color = pal(10),
               pos=c(0.12,0.1,.15,0.5), side=4,
               n.seg=1,
               border.col = "grey10",
               inside = T)
```



# Centrality

<aside>
ðŸ’¡ *Calculate in and out-degree centrality for each node and interpret the results:*
</aside>

**Degree centrality** is defined as the number of links incident upon a node. Having a directed network implies splitting the degree into in degree and out degree. The former counts the number of incoming edges to a node, while the latter refers to the number of edges a node directs to others [Freeman, L. C. (1978), Centrality in social networks conceptual clarification. Social networks, 1(3), 215-239.]. 

When edges express positive aspects (e.g., friendship, collaboration), in degree can be interpreted as a form of popularity and out degree as gregariousness. However, a reversed scenario is presented here due to the edges' negative connotation, i.e. bullying.

## In-degree

<aside>
ðŸ’¡ *Who is the most central when it comes to indegree?
Provide details of the meaning of the value (taking into account that the network is "who do you bully?").
Make sure to discuss the reference points for the in-degree measure. How does it compare to the theoretical minimum and maximum value?*
</aside>

Letâ€™s first consider the in-degree centrality of nodes with the function `degree(network, gmode, cmode="indegree")`, which will return the in-degree for each student. The same function can be used to compute the out-degree, setting `cmode="outdegree"`.

```{r}
# How many people are you bullied from?
indegree = sna::degree(net, gmode="digraph", cmode = "indegree")

# How many people do you bully? 
outdegree = sna::degree(net, gmode="digraph", cmode = "outdegree")

# Overall Degree
degree = sna::degree(net, gmode="digraph")
```

In order to present properly the degrees, a dataframe has been created, with names, in-degree, out-degree and total degree (sum of both in and out-degree). 

```{r}
# Create dataframe with names, in and out-degree
names = get.vertex.attribute(net, "vertex.names")
people = data.frame(names)
people$indegree = indegree
people$outdegree = outdegree
people$degree = degree

# Normalized indegree
nodes = length(net$val) - 1
people$norm_indegree = round(people$indegree / nodes,2)

people %>%
  arrange(desc(indegree))
```



# Centrality

*Calculate in and out degree centrality for each node and interpret the results:*

**Degree centrality** is defined as the number of links incident upon a node. Having a directed network implies splitting the degree into indegree and outdegree. The former counts the number of incoming edges to a node, while the latter refers to the number of edges a node directs to others^[Freeman, L. C. (1978). Centrality in social networks conceptual clarification. Social networks, 1(3), 215-239.]. When edges express positive aspects (e.g., friendship, collaboration), indegree can be interpreted as a form of popularity and outdegree as gregariousness. However, a reversed scenario is presented here due to the edges' negative connotation.

### Indegree
-   Who is the most central when it comes to indegree?

-   Provide details of the meaning of the value (taking into account that the network is "who do you bully?").

-   Make sure to discuss the reference points for the indegree measure. How does it compare to the theoretical minimum and maximum value?

```{r}
# How many people are you bullied from?
indegree = sna::degree(net, gmode="digraph", cmode = "indegree")

# How many people do you bully? 
outdegree = sna::degree(net, gmode="digraph", cmode = "outdegree")

# Overall Degree
degree = sna::degree(net, gmode="digraph")
```

In order to present properly the degrees, a dataframe has been created, with names, in-degree, out-degree and total degree (sum of both in and out-degree). 

```{r}

# Create dataframe with names, in and out-degree
names = get.vertex.attribute(net, "vertex.names")
people = data.frame(names)
people$indegree = indegree
people$outdegree = outdegree
people$degree = degree

# Normalized indegree
nodes = length(net$val) - 1
people$norm_indegree = people$indegree / nodes 

avg_indegree = mean(people$indegree)
median_indegree = median(sort(people$indegree))

people %>%
  arrange(desc(indegree))
```

```{r}
# In-degree distribution among nodes
ggplot(people)+
  geom_histogram(aes(x=indegree), stat="count")+
  geom_density(aes(x=indegree), stat="count")+
  labs(title = "Distribution of in degree")+
  xlab("In degree centrality")+ylab("Number of students")
  
  
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
headers = c("Most central", "Max indegree", "Min indegree", "Avg indegree", "Median indegree")
indegree_measure = c(tail(people$indegree, n=1), 
                     nodes, 0, 
                     avg_indegree, 
                     median_indegree)

tab = rbind(headers, indegree_measure, deparse.level = 0 )                   
knitr::kable(tab, caption = "Summary table of the indegree reference points")
```

```{r}
par(mar=c(0,0,0,0)) # Margin deletion
sna::gplot(net,
      gmode="digraph",    # directed network
      jitter=F,
      mode = "fruchtermanreingold",
      edge.col="grey70",  # set color of ties
      vertex.col=colours_1[attr$Ethnicity],   # set color of nodes
      vertex.cex = log(indegree)+0.2,
      vertex.sides= (attr$Gender-1)*47+4,
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default)

legend("topright",
       legend = c("Ethnicity"," 1st gen immigrants", " 2st gen immigrants", " Italian",
                  " ", "Gender", " Male", " Female"),
       col = c("white",colours_1[1],colours_1[2],colours_1[3],
               "white","white","black","black"), 
       bty = "n", 
       pch =c(15,15,15,15,15,15,19,18),
       pt.cex = c(0,2.1,2.1, 2.1,
                  0,0,2.1,2.1), 
       cex = 1, 
       text.col = "grey10", 
       horiz = F , 
       inset = c(0.01))
```


If the in-degree-centrality is considered, Sara is the most central node. As stated above, whereas in several cases having many incoming edges represents an advantageous condition for the individual, this specific network emphasizes an unfavourable status. Thus, in-degree measure refers to the number of bullies a node must face. Therefore, Sara results the chosen victim and gets bullied by nine people, which corresponds to the $0.375 \%$ of the other nodes (normalization through $\frac{indegree}{n-1} = \frac{9}{24} = 0.375$ with $n$ number of nodes).  Sara's condition in comparison with the worst case scenario, namely a complete centralization with 24 bullies and a single victim, results partially positive. However, if the average indegree is computed (having standard deviation $sd \pm$ `r round(sd(people$indegree),2)`), the value seems extremely high but does not take into consideration the distribution of indegree values. 

```{r}
person = people[order(people$indegree), ]$names 

barplot(sort(people$indegree), 
     main="Histogram for Indegree Values",
     names.arg = person,
     ylab="Indegree",
     border="#a8dadc", 
     col="#a8dadc", 
     las = 2)
abline(a=avg_indegree, b= 0, col = "red")
text(1,4, "avg indegree = 3.04", col = 2, adj = c(0, -.1)) 
```

Thus, the average is strongly impacted by the unbalanced situation within the network, meaning a group of six highly bullied victims against the remaining nodes assessing low in-degree values. The extreme cases ($indegree = 0$) are further analysed in the following sections and might reflect either isolate (i.e., Roberto) or bully figures. It is also worth noticing that Sara's condition seems not to be determined by her ethnicity but by her grade. While at least one member per ethnicity has been bullied, the reason for Sara's centrality might be the achievement of the highest mark: $10$.  

### Outdegree
-   Who is the most central when it comes to outdegree?

-   Provide details of the meaning of the value (taking into account that the network is "who do you bully?").

-   Make sure to discuss the reference points for the outdegree measure. How does it compare to the theoretical minimum and maximum value?

```{r}
# How many people do you bully? 
outdegree = sna::degree(net, gmode="digraph", cmode = "outdegree")
people$outdegree = outdegree
max_od = max(outdegree)

par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=F,
      edge.col="grey70",  # set color of ties
      vertex.col= ifelse(outdegree == max_od , "salmon", "lightblue"),
      vertex.cex = log(outdegree)+0.2,
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default)
```

There is no unique central node in the case of the outdegree measure. Thus, Aurora, Angela, and Francesco can be detected as the three most central nodes. It is also worth noticing that their degree measure is assessed at $9$ and, therefore, they are not the extreme cases hypothesised above (i.e., $indegree=0$). As already performed in the indegree case, some reference points are computed and reported below. 

```{r}
# Normalized outdegree
people$norm_outdegree = people$outdegree / nodes 
people$norm_outdegree 

avg_outdegree = mean(people$outdegree)
median_outdegree = median(sort(people$outdegree))

headers = c("Most central", "Max outdegree", "Min outdegree", "Avg outdegree", "Median outdegree")
outdegree_measure = c(tail(sort(people$outdegree), n=1), nodes, 0, avg_outdegree , median_outdegree )
tab = rbind(headers, outdegree_measure, deparse.level = 0 )                   
knitr::kable(tab, caption = "Summary table of the outdegree reference points")

```

Each of the three central outdegree nodes bullies almost one-third of the overall network: 
\[ \frac{outdegree}{n-1} = \frac{7}{24} = 0.291 \approx 0.29 \approx 1/3\]
These values are high above the average of `r avg_outdegree` $\pm$ `r round(sd(people$outdegree),2)` but do reach extreme cases, such as a centralized network (i.e., maximum outdegree). Therefore, a visual interpretation of the outdegree distribution in a bar plot graph may help understand the underlying reasons for low reference points.    

```{r}
person = people[order(people$outdegree), ]$names 

barplot(sort(people$outdegree), 
     main="Histogram for Outdegree Values",
     names.arg = person,
     ylab="Outdegree",
     border="#81b29a", 
     col="#81b29a", 
     las = 2)
abline(a=avg_outdegree, b= 0, col = "red")
text(1,4, "avg indegree = 3.04", col = 2, adj = c(0, -.1)) 
```

Once again, the outdegree measure shows an imbalanced situation assessing a significant gap between the lowest extreme cases, such as 0, and the highest ones.  The imbalance is determined by the three central nodes that become the primary senders of bullying acts. 

------------------------------------------------------------------------

*Let's assume we hypothesize that the grade of students might be impacted by how many others they are being bullied by. Calculate the correlation between the indegree and the grade of the kid.*

-   What is the correlation value?
-   What does it mean substantively?

```{r}

grade = attr$Grade
cor_value = cor(indegree, grade, method = c("pearson"))
cor_value
summary(cor_value)

# Creating the plot
plot(indegree, grade, 
     pch = 19,col = "#001219", 
     xlab="Indegree", ylab = "Grade", 
     main = "Correlation between indegree and grade", 
     xlim = c(0, max(indegree)+0.5), 
     ylim = c(0,10), xaxt="n")
axis(1, at = seq(0, 9, by = 1), las=2)
abline(lm(grade ~ indegree ), col = "#ae2012", lwd = 3)

text(1,4, expression(paste(rho, ": 0.85")), col = "#ae2012", adj = c(0, -.1)) 

cor.test(indegree,grade)

```

The Pearson coefficient, namely the correlation coefficient, is slightly above 0.85. Therefore, a strong and positive linear relationship can be detected between being bullied (i.e., indegree) and the school results. The number of bullies of a kid linearly depends on their grades. Thus, better marks correspond to a higher probability of being bullied. 
- statistically significant due to low p-value 

------------------------------------------------------------------------

*Perform a significance test using a permutation-based approach for the correlation as discussed in class. What does the significance test do and what do you conclude?*

```{r}

set.seed(21)

permutation = matrix(NA,1000,1)
for (k in c(1:1000))
{
  grade_perm = sample(grade)
  permutation[k,1] = cor(indegree, grade_perm)
}

hist(permutation, prob=TRUE, 
     xlim=c(-1.0,1.0), ylim = c(0.0, 2.0), 
     xlab = "Value of permutation", col = "#f2cc8f")

x <- seq(min(permutation), max(permutation))
curve(dnorm(x, mean=mean(permutation), sd=sd(permutation)), 
      col="#3d405b", lwd=2, add=TRUE)
text(x = 0.56, y = cor(indegree, grade), expression(paste("N~(", mu, "= 0.0, ", omega, "= 0.2)")), col = "#3d405b")
abline(v=cor(indegree, grade), lwd=2, col="#ae2012")
text(x = cor(indegree, grade)+0.1, y = cor(indegree, grade), expression(paste(rho, ": 0.85")), col = "#ae2012")

```


# Centralization and reciprocity

*Calculate the indegree and outdegree centralization for this network using the approach discussed in class and interpret. Make sure to show how you came to these answers.*

-   What do you conclude substantively (taking into account that the network is "who do you bully?")?
-   Make sure to discuss the reference points for the measure. What is the minimum and maximum value?

```{r}

```


------------------------------------------------------------------------

*Calculate the arc-based reciprocity index for this network and interpret. Make sure to show how you came to this answer.*

-   What do you conclude substantively (taking into account that the network is "who do you bully?")?
-   Make sure to discuss the reference points for the measure. What is the minimum, expected and maximum value?

```{r}

```

