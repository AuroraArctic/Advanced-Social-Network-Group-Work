---
title: "Bullying Network"
author: "Aurora Maria Tumminello, Lucia Hrovatin"

output: html_document
---


# Importing data

## Data pre-processing 
A pre-processing of the original dataset has been necessary. Thus, the original Excel table contained two sheets. Whereas a first attempt involved the function **read_excel(path, sheet = 2)** and implied the network's misreading, a manual split solved the deadlock. Therefore, separate CSV files have been created: 
<li> *bullying_attributes.csv*: containing the attributes of the network </li>
<li> *bullying_network.csv* : containing the actual matrix (i.e., network) </li><br> 
## Install libraries 

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(sna)
library(itsadug)
library(knitr)
```

### Import network data
```{r}
net = as.matrix(read.csv("bullying_network.csv", 
                         stringsAsFactors=FALSE, row.names=1))
net = as.network(net, directed=T)
summary(net)
```

### Import attributes
```{r}
attr = read.csv("bullying_attributes.csv")
```


# 1. Drawing a network

*Draw the network using the Fruchterman-Reingold layout with names (but without attributes).*

```{r}
par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=F,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col="cornflowerblue",   # set color of nodes
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default)
```

The *Fruchterman-Reingold* layout is the default mode of the **gplot()** function and therefore has not been included. Overall there are 25 labelled nodes connected through directed links. An individual, Roberto, does not present incoming or outgoing edges and, following the definition of Wasserman & Faust (1994), it is defined as an *isolate*^[Wasserman, S., & Faust, K. (1994). Social network analysis: Methods and applications.].

------------------------------------------------------------------------

*Next draw the network again using the Fruchterman-Reingold layout without names, but now with all 3 attributes (gender, grade and ethnicity) included using in some way a combination of color, shape and size of nodes.*

Considering that the three attributes are respectively:

* **Gender**: binomial variable 0/1 
* **Ethnicity**: categorical variable assuming three different values 
* **Grade**: categorical variable assuming 11 different values 

```{r}

# SIZE: Grade
# SHAPE: Gender
# COLOR: Ethnicity
color = c("#2a9d8f", "#e9c46a", "#e76f51")
  
par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=F,           
      edge.col="grey70",  # set color of ties
      vertex.col=color[attr$Ethnicity],   # set color of nodes depending on ethnicity 
      vertex.cex = log(attr$Grade), # set size of nodes depending on grade
      vertex.sides= (attr$Gender-1)*47+4) # set shape of nodes depending on gender  
```



### NOTARE che qui non abbiamo usato la SIZE!!!

```{r}
# SIZE: Grade
# SHAPE: Gender
# COLOR: Ethnicity

colors = c('#fff0f3', '#ffccd5', '#ffb3c1', '#ff8fa3', '#ff758f', 
           '#ff4d6d', '#c9184a', '#a4133c', '#800f2f', '#590d22',
           "#d8f3dc","#b7e4c7","#95d5b2","#74c69d","#52b788",
           "#40916c", "#2d6a4f","#245741","#1b4332","#081c15"
)

shapes = c(3,4,50)

par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=F,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col=colors[attr$Gender*10+attr$Grade+1],   # set color of nodes
      vertex.cex = 2,
      vertex.rot = 45,
      vertex.sides= shapes[attr$Ethnicity])

```

------------------------------------------------------------------------

*Create a legend for the attributes (this does not have to be with R, but needs to clarify how the different attributes were represented in the network).*

```{r}
color = c("#2a9d8f", "#e9c46a", "#e76f51")
  
par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=F,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col=color[attr$Ethnicity],   # set color of nodes
      vertex.cex = log(attr$Grade),
      vertex.sides= (attr$Gender-1)*47+4,
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default)
legend("topleft",
       legend = c("Ethnicity"," 1st gen immigrants", " 2st gen immigrants", " Italian",
                  " ", "Gender", " Male", " Female",
                  " ", "Grade", "0", "3", "7", "10"),
       col = c("white",color[1],color[2],color[3],
               "white","white","black","black",
               "white", "white", "black", "black", "black", "black"), 
       bty = "n", 
       pch =c(15,15,15,15,15,15,19,18),
       pt.cex = c(0,2.1,2.1, 2.1,
                  0,0,2.1,2.1,
                  0, 0, 1, log(3), log(7), log(10)), 
       cex = 1, 
       text.col = "grey10", 
       horiz = F , 
       inset = c(0.01))

```

or

```{r}
par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=F,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col=colors[attr$Gender*10+attr$Grade+1],   # set color of nodes
      vertex.cex = 1.5,
      vertex.rot = 45,
      vertex.sides= shapes[attr$Ethnicity],
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default))
legend("topleft",
       legend = c("Ethnicity"," 1st gen immigrants", " 2st gen immigrants", " Italian",
                  " ", "Gender", " Male", " Female",
                  " ", "Grade"),
       col = c("white","black","black", "black",
               "white","white","#52b788","#ff4d6d",
               "white", "white"), 
       bty = "n", 
       pch =c(15,17,15,19,
              15,15,15,15,
              15, 15),
       pt.cex = c(0,2.1,2.1, 2.2,
                  0,0,2.1,2.1,
                  0,0), 
       cex = 1, 
       text.col = "grey10", 
       horiz = F , 
       inset = c(0.01))

pal = colorRampPalette(colors[1:10])
gradientLegend(valRange=c(0,10), 
               color = pal(10),
               pos=c(0.05,0.1,.1,0.5), side=4, length = 0.5,
               inside = T)

pal = colorRampPalette(colors[11:20])
gradientLegend(valRange=c(0,10), 
               color = pal(10),
               pos=c(0.15,0.1,.2,0.5), side=4, length = 0.5,
               inside = T)
```

## Centrality

*Calculate in and out degree centrality for each node and interpret the results:*

**Degree centrality** is defined as the number of links incident upon a node. Having a directed network implies splitting the degree into indegree and outdegree. The former counts the number of incoming edges to a node, while the latter refers to the number of edges a node directs to others^[Freeman, L. C. (1978). Centrality in social networks conceptual clarification. Social networks, 1(3), 215-239.]. When edges express positive aspects (e.g., friendship, collaboration), indegree can be interpreted as a form of popularity and outdegree as gregariousness. However, a reversed scenario is presented here due to the edges' negative connotation.

### Indegree
-   Who is the most central when it comes to indegree?

-   Provide details of the meaning of the value (taking into account that the network is "who do you bully?").

-   Make sure to discuss the reference points for the indegree measure. How does it compare to the theoretical minimum and maximum value?

```{r}
# From how many people are you bullied? 
indegree = sna::degree(net, gmode="digraph", cmode = "indegree")
names = get.vertex.attribute(net, "vertex.names")
people = data.frame(indegree, names)
people$grade = attr$Grade

# Overall Degree 
degree = sna::degree(net, gmode="digraph")
people$degree = degree

par(mar=c(0,0,0,0)) # Margin deletion
sna::gplot(net,
      gmode="digraph",    # directed network
      jitter=F,
      mode = "fruchtermanreingold",
      edge.col="grey70",  # set color of ties
      vertex.col=color[attr$Ethnicity],   # set color of nodes
      vertex.cex = log(indegree)+0.2,
      vertex.sides= (attr$Gender-1)*47+4,
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default)

legend("topright",
       legend = c("Ethnicity"," 1st gen immigrants", " 2st gen immigrants", " Italian",
                  " ", "Gender", " Male", " Female"),
       col = c("white",color[1],color[2],color[3],
               "white","white","black","black"), 
       bty = "n", 
       pch =c(15,15,15,15,15,15,19,18),
       pt.cex = c(0,2.1,2.1, 2.1,
                  0,0,2.1,2.1), 
       cex = 1, 
       text.col = "grey10", 
       horiz = F , 
       inset = c(0.01))
```

```{r}

# Normalized indegree
nodes = length(net$val) - 1
people$norm_indegree = people$indegree / nodes 

avg_indegree = mean(people$indegree)
median_indegree = median(sort(people$indegree))

headers = c("Most central", "Max indegree", "Min indegree", "Avg indegree", "Median indegree")
indegree_measure = c(tail(people$indegree, n=1), nodes, 0, avg_indegree, median_indegree)
tab = rbind(headers, indegree_measure, deparse.level = 0 )                   
knitr::kable(tab, caption = "Summary table of the indegree reference points")

```

If the indegree-centrality is considered, Sara is the most central node. As stated above, whereas in several cases having many incoming edges represents an advantageous condition for the individual, this specific network emphasizes an unfavourable status. Thus, indegree measure refers to the number of bullies a node must face. Therefore, Sara results the chosen victim and gets bullied by nine people, which corresponds to the $0.375 \%$ of the other nodes (normalization through $\frac{indegree}{n-1} = \frac{9}{24} = 0.375$ with $n$ number of nodes).  Sara's condition in comparison with the worst case scenario, namely a complete centralization with 24 bullies and a single victim, results partially positive. However, if the average indegree is computed (having standard deviation $sd \pm$ `r round(sd(people$indegree),2)`), the value seems extremely high but does not take into consideration the distribution of indegree values. 

```{r}
barplot(sort(people$indegree), 
     main="Histogram for Indegree Values",
     xlab="Nodes",
     ylab="Indegree",
     border="#a8dadc", 
     col="#a8dadc")
abline(a=avg_indegree, b= 0, col = "red")
text(1,4, "avg indegree = 3.04", col = 2, adj = c(0, -.1)) 
```

Thus, the average is strongly impacted by the unbalanced situation within the network, meaning a group of six highly bullied victims against the remaining nodes assessing low in-degree values. The extreme cases ($indegree = 0$) are further analysed in the following sections and might reflect either isolate (i.e., Roberto) or bully figures. It is also worth noticing that Sara's condition seems not to be determined by her ethnicity but by her grade. While at least one member per ethnicity has been bullied, the reason for Sara's centrality might be the achievement of the highest mark: $10$.  

### Outdegree
-   Who is the most central when it comes to outdegree?

-   Provide details of the meaning of the value (taking into account that the network is "who do you bully?").

-   Make sure to discuss the reference points for the outdegree measure. How does it compare to the theoretical minimum and maximum value?

```{r}
# How many people do you bully? 
outdegree = sna::degree(net, gmode="digraph", cmode = "outdegree")
people$outdegree = outdegree
par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=F,
      edge.col="grey70",  # set color of ties
      vertex.col=color[attr$Ethnicity],   # set color of nodes
      vertex.cex = log(outdegree)+1,
      vertex.sides= (attr$Gender-1)*47+4,
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default)
```

------------------------------------------------------------------------

*Let's assume we hypothesize that the grade of students might be impacted by how many others they are being bullied by. Calculate the correlation between the indegree and the grade of the kid.*

-   What is the correlation value?
-   What does it mean substantively?

```{r}

```

------------------------------------------------------------------------

*Perform a significance test using a permutation-based approach for the correlation as discussed in class. What does the significance test do and what do you conclude?*

```{r}

```


# Centralization and reciprocity

*Calculate the indegree and outdegree centralization for this network using the approach discussed in class and interpret. Make sure to show how you came to these answers.*

-   What do you conclude substantively (taking into account that the network is "who do you bully?")?
-   Make sure to discuss the reference points for the measure. What is the minimum and maximum value?

```{r}

```


------------------------------------------------------------------------

*Calculate the arc-based reciprocity index for this network and interpret. Make sure to show how you came to this answer.*

-   What do you conclude substantively (taking into account that the network is "who do you bully?")?
-   Make sure to discuss the reference points for the measure. What is the minimum, expected and maximum value?

```{r}

```

