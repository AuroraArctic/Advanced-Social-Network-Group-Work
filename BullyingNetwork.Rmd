---
title: "Bullying Network"
author: "Aurora Maria Tumminello, Lucia Hrovatin"
output:
  html_document:
    toc: yes
    df_print: paged
  pdf_document:
    toc: yes
  html_notebook:
    toc: yes
    highlight: pygments
    theme: paper
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dpi=400,fig.width=7)
```

# Importing data

## Data Structure

The original dataset `bullying_network.xlsx` is an Excel file that contains two sheets about bullying within a group of 25 students in an Italian school class: the first one encloses three attributes per student; the second one represents the adjacency matrix of a directed network depicting who bullies whom among the students. 

The first sheet, the attributes one, contains:

- **gender**, mapped in females (0) and males (1);
- **grade**, which goes from 0 to 10;
- **ethnicity**, divided into three categories: first-generation immigrants (born abroad with foreign parents), second-generation immigrants (born in Italy with foreign parents) and Italians (born in Italy with at least one Italian parent).

## Data pre-processing

As forehead described, the original Excel file contains two sheets. To retrieve information there stored, a first approach exploited the `read_excel(path, sheet)` function and saved the two sheets in different variables. Since this attempt implied a network misreading of 0s and 1s as characters instead of double and creating an undirected graph, we opted for another importing action: the original Excel file has been separated manually into two different csv files:

- `bullying_attributes.csv`: containing the attributes of students inside the network;
- `bullying_network.csv`: containing the actual adjacency matrix (i.e. the network).

## Libraries

```{r message=FALSE, warning=FALSE, include=FALSE}
if (!require(tidyverse)) install.packages('tidyverse')
if (!require(sna)) install.packages('sna')
if (!require(knitr)) install.packages('knitr')
if (!require(itsadug)) install.packages('itsadug')
if (!require(formattable)) install.packages('formattable')
if (!require(igraph)) install.packages('igraph')
if (!require(visNetwork)) install.packages('visNetwork')
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(sna)
library(knitr)
library(itsadug) # For gradient legend
library(formattable) # For nice tables
library(igraph)
library(visNetwork)
```

## Data import

### Import network data

With the following code, the network is imported, converted into matrix and then into directed network.

```{r}
# Importing data
net = as.matrix(read.csv("bullying_network.csv",
                         stringsAsFactors=FALSE, row.names=1))
# Converting the adjacency matrix to a network
net = as.network(net, directed=T)
# Inspect the network
summary(net, print.adj = FALSE)
```

By inspecting the obtained network through `summary(net)`, we may notice:

- the number of vertices (i.e., nodes), which are 25 students;
- that the network is directed;
- that no hyperedges, loops or multiple edges are allowed;
- that there are overall 76 directed edges;
- that the density is `r round(network.density(net),3)`;
- that nodes are labeled with names, namely the studentsâ€™ first names.

### Import attributes

Students attributes have been saved in a distinct file and, therefore, imported separately. 

```{r}
# Reading the csv file with node attributes with given types for summary
attr = read.csv("bullying_attributes.csv", 
                colClasses = c("character","factor","numeric","factor"))
summary(attr)

```

As can be seen from the summary, there are more males than females, but this distinction is not significant since the class has an odd number of students. 
Instead, ethnicity registers a more significant difference, showing 11 immigrants and 14 Italians. The minimum grade is 3, although marks start typically from 0, while the maximum is 10. Both median and mean of the class are around 6, which corresponds to the sufficiency in the Italian system. 

```{r}
# Re-importing as numerical for the following plots and measures
attr = read.csv("bullying_attributes.csv")
```

# Drawing a network

## Basic Draw

<aside>
ðŸ’¡ *Draw the network using the Fruchterman-Reingold layout with names (but without attributes).*
</aside>

```{r, dpi=600}
par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      mode="fruchtermanreingold", # set mode as Fruchterman-Reingold
      jitter=F,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col="cornflowerblue",   # set color of nodes
      vertex.sides = 100,
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7,       # indicate the size of the labels (1 is default)
      arrowhead.cex = 0.4)
```

The *Fruchterman-Reingold* layout is the default mode of the `gplot()` function, and therefore it is not necessary to include it. Overall there are 25 labelled nodes connected through directed links representing who bullies whom. In particular, there is a student, Roberto, that does not present incoming or outgoing edges and, following the definition of Wasserman & Faust (1994), it is an **isolate**^[Wasserman, S., & Faust, K. (1994). Social network analysis: Methods and applications]. Therefore, Roberto is the only student in this specific school class that is not bullied and does not bully either.  


## Attribute-based network

<aside>
ðŸ’¡ *Next, draw the network again using the Fruchterman-Reingold layout without names, but now with all 3 attributes (gender, grade and ethnicity) included using in some way a combination of colour, shape and size of nodes.*

</aside>

<aside>
ðŸ’¡ *Create a legend for the attributes (this does not have to be with R, but needs to clarify how the different attributes were represented in the network).*

</aside>

Once again, letâ€™s consider the three attributes and their respective values:

- **Gender**: binomial variable 0/1;
- **Ethnicity**: categorical variable assuming three different values (1, 2 or 3);
- **Grade**: categorical variable assuming 11 different values (from 0 to 10).

These three attributes are all **categorical** data and, specifically, can be divided into **nominal** (gender and ethnicity) and **ordinal** (grade). This distinction implies a further difference in the visualisation. Whereas the nominal values can be mapped using variation in colour hue or shape, the ordinal ones may lead to different conclusions. Below two versions are displayed, using a combination of shape, colour and size. The first one variates the datum size (area) and fits data based on proportional scales where the larger sizes mean greater quantities (e.g., grade 10). The second option exploits the colours' lightness. Thus, lightness variation can represent quantitative scales, where the darker the colour, the greater the quantity^[Kirk, A. (2012). Data visualisation: a successful design process. Packt publishing LTD.].

### First version

A first version considers the variations in:

- **size** as grade;
- **shape** as gender;
- **colour** as ethnicity.

```{r}
colours_1 = c("#2a9d8f", "#e9c46a", "#e76f51")
sizes = seq(0.1, 4, length.out=11)

par(mar=c(0,0,0,0))
gplot(net,
      gmode="digraph",    # directed network
      jitter=T,
      edge.col="grey70",  # set color of ties
      vertex.col=colours_1[attr$Ethnicity], # set color of nodes depending on ethnicity
      vertex.cex = sizes[attr$Grade], # set size of nodes depending on grade
      vertex.sides= (attr$Gender-1)*47+4, # set shape of nodes depending on gender
			vertex.rot = 45, # Nodes rotation
      arrowhead.cex = 0.5) # Size of the arrows head
```

In this representation, both gender and ethnicity are evident, while the size does not accurately represent the grade. Moreover, to visualize the grade, a size vector proportionally maps the node's size to its grade. Although this combination satisfies the assigned requirements, the user might experience difficulties distinguishing the grades differences.

In the following chunk, a legend is added to guide the user in the reading of the network:

- ethnicity, through hue colour, represents 1st and 2nd generation of immigrants and Italians;
- shapes map the gender of students: circles for males and squares for females;
- grades vary in size, whose proportion is reported in the legend. Notice that the legend's proportion does not precisely match the sizes displayed in the network.

```{r}
sizes = seq(0.2, 3, length.out=11)

par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=T,           
      edge.col="grey70",  # set color of ties
      vertex.col=colours_1[attr$Ethnicity],   # set color of nodes depending on ethnicity 
      vertex.cex = sizes[attr$Grade], # set size of nodes depending on grade
      vertex.sides= (attr$Gender-1)*47+4, # set shape of nodes depending on gender  
      vertex.rot = 45,
      arrowhead.cex = 0.5,
      displaylabels=T,    # indicate that labels should be included
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default)

legend("topleft",
       legend = c("Ethnicity"," 1st gen immigrants", " 2st gen immigrants", " Italian",
                  " ", "Gender", " Male", " Female",
                  " ", "Grade", 0:10),
       col = c("white",colours_1[1],colours_1[2],colours_1[3],
               "white","white","black","black",
               "white", "white", rep("black",11)), 
       bty = "n", 
       pch =c(15,15,15,15,
              15,15,19,15,
              15,15,rep(19,11)),
       pt.cex = c(0,2.1,2.1, 2.1,
                  0,0,2.1,2.1,
                  0, 0, (0:10)/5), 
       cex = 1, 
       text.col = "grey10", 
       horiz = F , 
       inset = c(0.01))
```

### Second version

As stated above, the second approach represents the attributes in a different way:

- **shape**: ethnicity (i.e., first-generation as triangles, second-generation as squares and Italians as circles);
- **colour hue**: gender (i.e., females as red, males as green);
- **colour lightness**: grade (the darker the higher, the lighter the lower).

```{r}
colours_2 = c('#fff0f3', '#ffccd5', '#ffb3c1', '#ff8fa3', '#ff758f', # Reds
              '#ff4d6d', '#c9184a', '#a4133c', '#800f2f', '#590d22', # Reds
              "#d8f3dc","#b7e4c7","#95d5b2","#74c69d","#52b788",     # Greens
              "#40916c", "#2d6a4f","#245741","#1b4332","#081c15"     # Greens
)

shapes = c(3,4,50)

par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=F,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col=colours_2[attr$Gender*10+attr$Grade+1],   # set color of nodes
      vertex.cex = 1.3,
      vertex.rot = 45,
      vertex.sides= shapes[attr$Ethnicity],
      arrowhead.cex = 0.5)
```

Despite ethnicity losing evidence, the grade variable acquires a central role in this visualisation. Thus, the use of colour lightness to highlight the grades (i.e. higher grades with darker colours) emphasizes the differences more than in the previous case where size was employed. 

Notice that the exercise also required the use of **size**. However, applying size variation to gender or ethnicity may unconsciously suggest a social superiority of one of the two categories, which does not exist. Thus, this visualisation does not consider the size to avoid any possible misunderstanding.

In this case, the legend shows:

- ethnicity as shapes;
- gender as one of the two colours;
- grade as a gradient, varying between males and females, whose lightness relies on the studentsâ€™ grade.

This solution may help understand the grade distribution among students, but getting the exact grade is still challenging.

```{r}
par(mar=c(0,0,0,0)) # Margin deletion
gplot(net,
      gmode="digraph",    # directed network
      jitter=T,           # do not allow nodes to be "jittered"
      edge.col="grey70",  # set color of ties
      vertex.col=colours_2[attr$Gender*10+attr$Grade+1],   # set color of nodes
      vertex.cex = 1,
      vertex.rot = 45,
      vertex.sides= shapes[attr$Ethnicity],
      displaylabels=T,    # indicate that labels should be included
      arrowhead.cex = 0.5,
      label.pos=1,        # indicate that labels should be given below points
      label.cex=.7)       # indicate the size of the labels (1 is default))

# Legend for gender and ethnicity
legend("topleft",
       legend = c("Ethnicity"," 1st gen immigrants", " 2st gen immigrants", " Italian",
                  " ", "Gender", " Male", " Female",
                  " ", "Grade"),
       col = c("white","black","black", "black",
               "white","white","#52b788","#ff4d6d",
               "white", "white"), 
       bty = "n", 
       pch =c(15,17,15,19,
              15,15,15,15,
              15, 15),
       pt.cex = c(0,2.1,2.1, 2.2,
                  0,0,2.1,2.1,
                  0,0), 
       cex = 1, 
       text.col = "grey10", 
       horiz = F , 
       inset = c(0.01))

# Gradient legend
pal = colorRampPalette(colours_2[1:10])
gradientLegend(valRange=c(0,10), 
               color = pal(10),
               pos=c(0.05,0.1,.08,0.5), 
               side=4, 
               n.seg=1,
               border.col = "grey10",
               inside = T)

pal = colorRampPalette(colours_2[11:20])
gradientLegend(valRange=c(0,10), 
               color = pal(10),
               pos=c(0.12,0.1,.15,0.5), side=4,
               n.seg=1,
               border.col = "grey10",
               inside = T)
```

### Third interactive version {#a-interactiveVisualization}

This third version exploits the package `visNetwork` to build an interactive visualisation of the network, reproducing the first version forehead proposed, where:

- shapes indicate the gender (i.e. females as circles, males as squares);
- colour hue indicates the ethnicity, as shown in the legend;
- the size is handled based on the grade of the single student.

Moreover, ethnicity can be chosen through the selection above the plot.

```{r}
# Creation of the igraph network
i_net<-graph_from_adjacency_matrix(as.matrix(read.csv("bullying_network.csv",
                                                      row.names = 1, 
                                                      stringsAsFactors = F)),
                                   mode="directed", diag=F)

# Setting colours, shapes, sizes, ethnicity, gender, title
V(i_net)$color = colours_1[attr$Ethnicity]
V(i_net)$shape = c("dot","square")[attr$Gender+1]
V(i_net)$size = attr$Grade*3
V(i_net)$ethnicity = ifelse(attr$Ethnicity==3, "Italian",
                            ifelse(attr$Ethnicity == 1,"1st immigrant", "2nd immigrant"))
V(i_net)$gender = ifelse(attr$Gender == 0, "Female","Male")
V(i_net)$title = paste0("<p><b>", attr$ID,"</b><br>",
                        V(i_net)$gender,", ",attr$Grade,", ",
                        V(i_net)$ethnicity,"</p>")

# Dataframe for the legend
lnodes <- data.frame(label = c("1st immigrants","2nd immigrants","Italians","Females", "Males"),
                     shape = c(rep("triangle",3),"dot","square"), 
                     color = c(colours_1,"#B78FB5","#B78FB5"),
                     font.size = 10,
                     title = "Informations") 

# Creation of the visNetwork object
new_net = toVisNetworkData(i_net)

# Actual visualisation
visNetwork(nodes = new_net$nodes,
           edges = new_net$edges,
           height = "800px", width = "100%",
           font.size = 9,
           physics = T) %>%
    visEdges(arrows = "to") %>%
    visOptions(highlightNearest = TRUE, 
               selectedBy = "ethnicity") %>%
    visIgraphLayout(layout = "layout.fruchterman.reingold") %>%
    visLegend(addNodes = lnodes, useGroups = FALSE, ncol = 1)
```

The interactive version offers better exploitation and comprehension of the network through the possibility of visualising all the information related to a node by just clicking on it. By introducing a further layer, the problem of grades definition and comparison is solved.

# Centrality

<aside>
ðŸ’¡ *Calculate in and out-degree centrality for each node and interpret the results.*

</aside>

**Degree centrality** is defined as the number of links incident upon a node. Having a directed network implies splitting the degree into in-degree and out-degree. The former counts the number of incoming edges to a node, while the latter refers to the number of edges a node directs to others^[Freeman, L. C. (1978), Centrality in social networks conceptual clarification. Social networks, 1(3), 215-239.]. 

When edges express positive aspects (e.g., friendship, collaboration), in-degree can be interpreted as a form of popularity and out-degree as gregariousness. However, a reversed scenario is presented here due to the edges' negative connotation, i.e. bullying.

## In-degree

<aside>
ðŸ’¡ *Who is the most central when it comes to in-degree?*
</aside>

<aside>
ðŸ’¡ *Provide details of the meaning of the value (taking into account that the network is "who do you bully?").*
</aside>

<aside>
ðŸ’¡ *Make sure to discuss the reference points for the in-degree measure. How does it compare to the theoretical minimum and maximum value?*

</aside>

Letâ€™s first consider the in-degree centrality of nodes with the function `degree(network, gmode, cmode="indegree")`, which will return the in-degree for each student. The same function can be used to compute the out-degree, setting `cmode="outdegree"`.

```{r}
# How many people are you bullied from?
indegree = sna::degree(net, gmode="digraph", cmode = "indegree")

# How many people do you bully? 
outdegree = sna::degree(net, gmode="digraph", cmode = "outdegree")

# Overall Degree
degree = sna::degree(net, gmode="digraph")

attr$indegree = indegree
attr$outdegree = outdegree
```

To properly present the degree centrality measures, a dataframe has been created with students names, in-degree, out-degree and total degree (i.e. the sum of both in and out-degree). In addition, the normalized in-degree is computed by dividing the in-degree over the number of nodes minus $1$ (i.e. $n-1$). The last column indicates whether the single node in-degree is below (or above) the average.

```{r echo=FALSE}
tile_colors = c("#B78FB5", # lilac
                "#25D0BC", # green
                "#71A2C1")
# Create dataframe with names, in and out-degree
names = net %v% "vertex.names"    # Get vertex names
people = data.frame(Name = names) # Create data frame with names column
people$`In degree` = indegree        # Insert in degree
people$`Out degree` = outdegree      # Insert out degree
people$Degree = degree            # Insert total degree

# Normalized indegree
nodes = length(net$val) - 1
people$`Normalized In degree` = round(people$`In degree`/nodes,2)

# Average and median in degree
avg_indegree = mean(people$`In degree`)
median_indegree = median(people$`In degree`)

people$`Above Average (In degree)` =  ifelse(indegree<=avg_indegree, "No", "Yes")
    
people %>%
    arrange(desc(indegree)) %>%
    formattable(align = c("l",rep("c",5)),
                list(
                    'Name' = formatter("span", style = ~ style(color = "grey",font.weight = "bold")),
                    'In degree' = color_tile("transparent", tile_colors[1]),
                    'Out degree' = color_tile("transparent",tile_colors[2]),
                    'Degree' = color_tile("transparent", tile_colors[2]),
                    'Normalized In degree' = color_tile("transparent", tile_colors[1]),
                    'Above Average (In degree)' = formatter("span", x ~ icontext(ifelse(x == "Yes", "ok", "remove")), 
                                                style = x ~ style(color = ifelse(x == "Yes", tile_colors[1], tile_colors[2])))))
```

By considering the in-degree centrality, Sara can be defined as the most central node, followed by Gianna and Marco. As stated above, whereas having many incoming edges represents an advantageous condition for the individual in several cases, this specific network emphasizes an unfavourable status. Thus, in-degree measure refers to the number of bullies a node must face. Consequently, Sara results the chosen victim and gets bullied by $9$ people, which corresponds to the $0.375\%$ of the network (normalization obtained by $\frac{in-degree}{n-1} = \frac{9}{24} = 0.375$, with $n$ number of nodes). 

In the worst-case scenario, Sara would be bullied by $24$ students, and she would be the only victim. However, despite her seeming far from the depicted scenario, her in-degree looks exceptionally high considering the average and the median in-degree. The same happens for students like Gianna, Marco, Andrea, Mario, Valentina and Giulia. 

It is also worth noticing that Sara's condition seems not to be determined by her ethnicity or gender, but by her grade. While at least one member per ethnicity and/or per gender has been bullied, the reason for which Sara is bullied by several students might be the achievement of the highest mark: $10$.

```{r echo=FALSE}
results = data.frame(Measures = c("Most central node", 
                                  "Max in degree",
                                  "(Theoretical) max in degree",
                                  "Least central nodes",
                                  "Min in degree", 
                                  "(Theoretical) min in degree",
                                  "Average in degree", 
                                  "Median in degree"))

results$Value = c(people[which.max(people$`In degree`),]$Name,
                  max(people$`In degree`),
                  nodes,
                  paste0(c(people[which(people$`In degree` == min(people$`In degree`)),]$Name), collapse=", "),
                  min(people$`In degree`),
                  0, 
                  avg_indegree, 
                  median_indegree)

formattable(results,
            align = c("l","l"))
```

As the bar plot below shows, the average is strongly impacted by the unbalanced situation within the network, meaning a group of highly bullied victims against the remaining nodes assessing low in-degree values. The extreme cases ($in-degree = 0$) are further analysed in the following sections and might reflect either isolate (i.e. Roberto) or bully figures.

```{r echo=FALSE, warning=FALSE}
# In-degree distribution among nodes
ggplot(people)+
    geom_histogram(aes(x=indegree), stat="count", fill="#B78FB3")+
    xlab("In degree centrality")+ylab("Number of students") +
    theme_minimal()+ ggtitle("Distribution of In degree") +
  theme(plot.title = element_text(hjust = 0.5))
```

Note that the following network nodes size indicates whether the in-degree is above average (bigger) or not (smaller), exploiting the interactive version proposed in section ===QUI===.

```{r echo=FALSE}
# Setting colours, shapes, sizes, ethnicity, gender, title
V(i_net)$color = colours_1[attr$Ethnicity]
V(i_net)$shape = c("dot","square")[attr$Gender+1]
V(i_net)$size = ifelse(people$`Above Average (In degree)`== "Yes",30,10)
V(i_net)$ethnicity = ifelse(attr$Ethnicity==3, "Italian",
                            ifelse(attr$Ethnicity == 1,"1st immigrant", "2nd immigrant"))
V(i_net)$gender = ifelse(attr$Gender == 0, "Female","Male")
V(i_net)$title = paste0("<p><b>", attr$ID,"</b><br>",
                        V(i_net)$gender,", ",attr$Grade,", ",
                        V(i_net)$ethnicity,"<br>In degree: ",
                        attr$indegree,"</p>")

# Creation of the visNetwork object
new_net = toVisNetworkData(i_net)

# Actual visualisation
visNetwork(nodes = new_net$nodes,
           edges = new_net$edges,
           height = "800px", width = "100%",
           font.size = 9,
           physics = T) %>%
    visEdges(arrows = "to") %>%
    visOptions(highlightNearest = TRUE) %>%
    visIgraphLayout(layout = "layout.fruchterman.reingold") %>%
    visInteraction(dragNodes = FALSE, 
                   dragView = FALSE, 
                   zoomView = FALSE)
```

## Outdegree

<aside>
ðŸ’¡ *Who is the most central when it comes to out degree?*
</aside>

<aside>
ðŸ’¡ *Provide details of the meaning of the value (taking into account that the network is "who do you bully?").*
</aside>

<aside>
ðŸ’¡ *Make sure to discuss the reference points for the outdegree measure. How does it compare to the theoretical minimum and maximum value?*

</aside>


There is no unique central node in the case of the out-degree measure. Thus, Angela, Aurora, and Francesco can be detected as the $3$ most central nodes (as shown in the table below). It is also worth noticing that their degree measure is assessed at $9$ and $8$ and, therefore, they are not the extreme cases hypothesized above (i.e., $in-degree=0$).
As already performed in the in-degree case, some reference points are computed and reported below.

```{r echo=FALSE}
# Normalized outdegree
people$`Normalized Out degree` = round(people$`Out degree`/nodes, 3)

# Average and median out degree
avg_outdegree = mean(people$`Out degree`)
median_outdegree = median(sort(people$`Out degree`))

people$`Above Average (Out degree)` =  ifelse(outdegree<=avg_outdegree, "No", "Yes")

people %>%
    select(Name, `Out degree`,`In degree`,
           Degree, `Normalized Out degree`, `Above Average (Out degree)`) %>%
    arrange(desc(outdegree)) %>%
    formattable(align = c("l",rep("c",5)),
                list(
                    'Name' = formatter("span", style = ~ style(color = "grey",
                                                               font.weight = "bold")),
                    'In degree' = color_tile("transparent", tile_colors[1]),
                    'Out degree' = color_tile("transparent",  tile_colors[2]),
                    'Degree' = color_tile("transparent",  tile_colors[1]),
                    'Normalized Out degree' = color_tile("transparent",  tile_colors[2]),
                    'Above Average (Out degree)' = formatter("span", x ~ icontext(ifelse(x == "Yes", "ok", "remove")), 
                                                style = x ~ style(color = ifelse(x == "Yes",  tile_colors[2],  tile_colors[1])))))
```


```{r echo=FALSE}
results = data.frame(Measures = c("Most central node", 
                                  "Max out degree",
                                  "(Theoretical) max out degree",
                                  "Least central nodes",
                                  "Min out degree", 
                                  "(Theoretical) min out degree",
                                  "Average out degree", 
                                  "Median out degree"))

results$Value = c(paste0(c(people[which(people$`Out degree` == max(people$`Out degree`)),]$Name), collapse=", "),
                  max(people$`Out degree`),
                  nodes,
                  paste0(c(people[which(people$`Out degree` == min(people$`Out degree`)),]$Name), collapse=", "),
                  min(people$`Out degree`),
                  0, 
                  avg_outdegree, 
                  median_outdegree)

formattable(results,
            align = c("l","l"))
```

Each of the three central out-degree nodes bullies almost one-third of the overall network: 

$$
\left[ \frac{outdegree}{n-1} = \frac{7}{24} = 0.291 \approx 0.29 \approx \frac{1}{3}\right]
$$

These values are highly above the average of `r avg_outdegree` $\pm$ `r round(sd(people[,"Out degree"]),3)` but do not reach extreme cases, such as in a completely centralized network (i.e. maximum out-degree). Moreover, a visual interpretation of the out-degree distribution in a bar plot graph may help understand the underlying reasons for the low reference points.    

```{r echo=FALSE}
ggplot(people)+
    geom_bar(aes(x=reorder(`Name`,`Out degree`),y=`Out degree`), 
             stat='identity',
             fill="#B78FB3")+
    geom_hline(yintercept=3.04, linetype="dashed", color = "#1FAD9D", size=1.5)+
    theme_minimal()+ ggtitle("Distribution of Out degree Values") +
    theme(axis.text.x = element_text(angle =45, hjust=1), plot.title = element_text(hjust = 0.5))+
    xlab("Students")+
    annotate(geom="text", x=4, y=3.5, label="Average out-degree = 3.04",color="#1FAD9D")
```

Once again, the out-degree measure shows an imbalanced situation assessing a significant gap between the lowest extreme cases (e.g. $0$) and the highest ones (i.e.,$7$). Overall, $15$ nodes have an out-degree below average, while the remaining $10$ nodes score slightly above average or double it in the most central nodes. 

Note that the following network nodes size indicates whether the out-degree is above average (bigger) or not (smaller), exploiting the interactive version proposed in section ===QUI===.

```{r echo=FALSE}
# Setting colours, shapes, sizes, ethnicity, gender, title
V(i_net)$color = colours_1[attr$Ethnicity]
V(i_net)$shape = c("dot","square")[attr$Gender+1]
V(i_net)$size = ifelse(people$`Above Average (Out degree)`== "Yes",30,10)
V(i_net)$ethnicity = ifelse(attr$Ethnicity==3, "Italian",
                            ifelse(attr$Ethnicity == 1,"1st immigrant", "2nd immigrant"))
V(i_net)$gender = ifelse(attr$Gender == 0, "Female","Male")
V(i_net)$title = paste0("<p><b>", attr$ID,"</b><br>",
                        V(i_net)$gender,", ",attr$Grade,", ",
                        V(i_net)$ethnicity,"<br>Out degree: ",
                        attr$outdegree,"</p>")

# Creation of the visNetwork object
new_net = toVisNetworkData(i_net)

# Actual visualisation
visNetwork(nodes = new_net$nodes,
           edges = new_net$edges,
           height = "800px", width = "100%",
           font.size = 9,
           physics = T) %>%
    visEdges(arrows = "to") %>%
    visOptions(highlightNearest = TRUE) %>%
    visIgraphLayout(layout = "layout.fruchterman.reingold") %>%
    visInteraction(dragView = FALSE, 
                   zoomView = FALSE)
```

## Correlations

<aside>
ðŸ’¡ *Let's assume we hypothesize that the grade of students might be impacted by how many others they are being bullied by. Calculate the correlation between the in-degree and the grade of the kid.*

-   *What is the correlation value?*
-   *What does it mean substantively?*
</aside>

### Grade and in-degree

```{r}
grade = attr$Grade
cor_value = cor(indegree, grade, method = c("pearson"))
cor_value
```

The Pearson coefficient on in-degree and grade, namely the correlation coefficient, is slightly above `r round(cor_value,3)`. Therefore, a strong and positive linear relationship can be detected between being bullied (i.e., in-degree) and the school results. The number of bullies of a kid linearly depends on their grades. Thus, better marks correspond to a higher probability of being bullied. 

```{r}
cor.test(indegree,grade)
```

Moreover, the correlation test shows a low p-value, indicating a statistically significant relationship between the number of people that bully and the grade they get, illustrated by the following scatter plot. In particular, each data point is described in terms of grade (y-axis) and in-degree (x-axis). The linear relationship between these variables is reported along with its $95%$ confidence interval.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Linear relationship between in degree and grade
ggplot(people,aes(x = indegree, y = grade))+
    stat_smooth(method = "lm", color = "#1FAD9D", fill = "#A8F0E9")+
    geom_point(size = 2.5, color = "#1FAD9D")+
    theme_minimal()+
    theme(axis.text.x = element_text(angle =45, hjust=1))+
    labs(title = "Linear relationship between in degree and grade")
```
However, despite the high correlation coefficient, it is worth noticing some fallacies in the model:

1. Low number of students: since our sample has a small number of subjects, this model is not representative for the entire school system bullying mechanism;
2. The line fits the majority of points. Nevertheless, some outliers can be detected from the plot (e.g. point at coordinates $p=(3,9)$).

For confirming the relationship between grade and being bullied, the ANOVA test is applied, showing a low p-value and therefore a discriminant factor for the studied network. In particular, the pairwise test displays pairs of grades where there is a substantial difference in terms of being bullied. For instance, $8$ and $3$ grades tend to be inside the mechanism of bullying, while $4$ and $3$ don't.

```{r}
res.aov <- aov(indegree ~ as.factor(Grade), data = attr)
summary(res.aov)
TukeyHSD(res.aov)
```

Instead, by focusing on the grade and bullying (i.e. out-degree), the p-value results high, leading to the conclusion that the relationship is not statistically significant. 

```{r}
res.aov <- aov(outdegree ~ as.factor(Grade), data = attr)
summary(res.aov)
```

### Gender

This section hosts t-tests which try to identify differences in terms of mean of two different groups: males and females. These tests were led on in-degree and out-degree. However, no significant p-value was obtained from these tests, meaning that gender is not discriminant in the bullying behaviour inside the class. 

```{r}
# Mean difference between males and females (in degree)
t.test(filter(attr,Gender==0)$indegree,
       filter(attr,Gender==1)$indegree)

# Mean difference between males and females (out degree)
t.test(filter(attr,Gender==0)$outdegree,
       filter(attr,Gender==1)$outdegree)
```

### Ethnicity

For completeness, some tests are run for ethnicity too. Since there are three ethnic groups among students, ANOVA tests investigate pairwise differences. As `TukeyHSD()` shows, the p-values are not significant and therefore ethnicity is not discriminant for bullying or being bullied. 

```{r}
# Being bullied and ethnicity
res.aov <- aov(indegree ~ as.factor(Ethnicity), data = attr)
summary(res.aov)
TukeyHSD(res.aov)

# Bullying and ethnicity
res.aov <- aov(outdegree ~ as.factor(Ethnicity), data = attr)
summary(res.aov)
TukeyHSD(res.aov)
```

### Permutation-based approach

<aside>
ðŸ’¡ *Perform a significance test using a permutation-based approach for the correlation as discussed in class. What does the significance test do and what do you conclude?*

</aside>

A **permutation-based test** (also called re-randomization test) is a statistical significance test in which the distribution of the test under the null hypothesis is obtained by calculating all possible values of the test under all possible rearrangements of the observed data points. This test is performed on $1000$ permutations of the grade over students' in-degree and computes the Pearson correlation coefficient between them.

```{r}
set.seed(21)

permutation = matrix(NA,1000,1)
for (k in c(1:1000))
{
  grade_perm = sample(grade)
  permutation[k,1] = cor(indegree, grade_perm)
}

# Histogram
hist(permutation, prob=TRUE, 
     xlim=c(-1.0,1.0), ylim = c(0.0, 2.0), 
     xlab = "Value of permutation", col = "#C7A8C5")

x <- seq(min(permutation), max(permutation))

# Gaussian curve
curve(dnorm(x, mean=mean(permutation), sd=sd(permutation)), 
      col="#7C5079", lwd=2, add=TRUE)
text(x = 0.56, y = cor(indegree, grade), 
     expression(paste("N~(", mu, "= 0.0, ", sigma, "= 0.2)")), col = "#3E283D")

# P-value line
abline(v=cor(indegree, grade), lwd=2, col="#7C5079")
text(x = cor(indegree, grade)+0.1, y = cor(indegree, grade),
     expression(paste(rho, ": 0.85")), col = "#7C5079")
```
As the histogram above shows, after all the permutations, a Gaussian distribution is reached within the range of values of Pearson coefficient (i.e. $[-1,1]$), whose mean is around $0$. This happens because it is more likely to find no correlation (i.e. $0$) between random permutations of grade and in-degree than perfect ones (i.e. $-1,1$). Moreover, as indicated by the straight vertical line at $x = 0.85$, the Pearson coefficient of the initial sample is far away from the average correlation obtained by permuting data.

```{r}
pnorm(cor_value, mean = mean(permutation), sd = sd(permutation), lower.tail = T)
```

The function `pnorm()` assesses that the correlation coefficient of the original sample is above the $99%$ of the coefficients computed by randomly permuting data. Hence, obtaining a Pearson coefficient $\rho = $`r round(cor_value,3)` would be possible in less than $1\%$ of the cases and it is therefore statistically significant. 

# Centralization and reciprocity

## Centralization

<aside>
ðŸ’¡ *Calculate the in-degree and out-degree centralization for this network using the approach discussed in class and interpret. Make sure to show how you came to these answers.*
    
ðŸ’¡ *What do you conclude substantively (taking into account that the network is "who do you bully?")?*

ðŸ’¡ *Make sure to discuss the reference points for the measure. What are the minimum and maximum values?*

</aside>

Centralization is a question about how central some nodes are compared to other nodes, and it is a characteristic of the network itself. While centrality is more related to the individual sphere of the nodes, centralization regards the distribution of the centrality inside the network. ===QUI===

In an undirected network, centralization is computed as follows:

$$
Centralization = \frac{\sum (\max-degree_i)}{(n-1)(n-2)}
$$
The most centralized network is the one that has a single node in the centre, which links every other node in the network. In this case, the maximum degree is $(n-1)$ and the centralization index returns $1$:

$$
C_{max} = \frac{(24-1) \cdot 24+(24-24)\cdot1}{24\cdot23} = \frac{23\cdot24}{23\cdot24} = 1
$$

In the opposite case, namely in a decentralized network, every node is linked to everybody else and the centralization index is $0$:

$$
C_{min} = \frac{(24-24)\cdot25}{24\cdot23} = \frac{0}{23\cdot24} = 0
$$

```{r}
# Total degree centralization
sna::centralization(net,sna::degree)
```

In the bullying network, the centralization index is `r round(sna::centralization(net,sna::degree),3)`, which indicates a reasonably decentralized network. 

Since the bullying network is directed, it is possible to split the centralization index into in-degree and out-degree. As the table below shows, the in-degree centralization index is higher than the out-degree one, indicating a more centralized bullied network (i.e. few kids are bullied from many) and a less centralized bullying network (i.e. nearly everybody bullies others).

Notice that both indexes are higher than the degree centralization index (i.e. `r round(sna::centralization(net,sna::degree),3)`), suggesting the presence of two more centralized sub-networks. 

```{r message=FALSE, warning=FALSE}
table = formattable(data.frame(
    "Centralization index" = round(sna::centralization(net,sna::degree),3),
    # In degree centralization
    "In degree Centralization Index" = round(sna::centralization(net,sna::degree, cmode="indegree"),3),
    # Out degree centralization
    "Out degree Centralization Index" = round(sna::centralization(net,sna::degree, cmode="outdegree"),3)))

names(table) = c("Centralization Index", "In degree Centralization Index", "Out degree Centralization Index")
table
```

Moreover, considering the two hypothetical extremes, meaning the maximum (i.e. $1$) and minimum (i.e. $0$) centralization indexes, it can be noticed that the computed ones are closer to the minimal reference point than to the maximal. It is worth noticing that the sub-networks (i.e. bullying and being bullied) are decentralized due to multiple central nodes. 

## Reciprocity

<aside>
ðŸ’¡ *Calculate the arc-based reciprocity index for this network and interpret. Make sure to show how you came to this answer.*

</aside>

<aside>
ðŸ’¡ *What do you conclude substantively (taking into account that the network is "who do you bully?")?*

</aside>

<aside>
ðŸ’¡ *Make sure to discuss the reference points for the measure. What is the minimum, expected and maximum value?*

</aside>

Before computing the reciprocity index, a census about dyads is performed to understand the state-of-art, meaning how many *mutual*, *asymmetric* and *null* dyads are present. 

```{r}
sna::dyad.census(net)
```

Given $25$ nodes, the maximal number of edges is $(25 \cdot 24)/2 = 300$, while the minimal is $0$. In this specific network, there are:

* 68 *asymmetrical* edges;
* 228 *null* or *missing* edges;
* 4 *mutual* edges: Francesco - Andrea, Flavio - Giulia, Angelo - Giulia and Marco - Sara. 
    
```{r}
# Mutual edges
E(i_net)[which_mutual(i_net)]
```

By looking at the table below with the nodes involved in the mutual edges, we can notice that:

- Flavio and Marco bully just one person (i.e. Giulia and Sara respectively), but their victims, in turn, bully them, creating a cycle of attack and defense;
- Giulia appears twice in these mutual edges, which represent half of her in and out-edges. This might suggest a counterattack technique: responding to the bullies by bullying them.

```{r echo=FALSE}
# Degree Centrality of nodes with mutual links
people %>%
    select(-`Above Average (Out degree)`,-`Above Average (In degree)`) %>%
    filter(Name %in% c("Francesco", "Andrea", 
                       "Flavio", "Marco", 
                       "Giulia", "Sara", "Angelo")) %>%
    formattable()
```

As a further step, the reciprocity index is computed as the number of mutual dyads (i.e. $M$) in the network over the total amount of edges, namely the sum of mutual ($M$) and asymmetric edges ($A$):

$$
Reciprocity = \frac{2\cdot M}{2\cdot M+A}
$$

```{r}
sna::grecip(net, measure="edgewise")
```

The computation above yields a reciprocity rate of `r round(sna::grecip(net, measure="edgewise"), 3)`, meaning that almost $11 \%$ of the network drives to mutual relations between nodes (i.e., counterattack technique). 

$$
Reciprocity = \frac{2\cdot 4}{2\cdot 4+68} = \frac{8}{76} = 0.105 \approx 11\%
$$

Therefore, the **arc-based reciprocity** (also called edgewise or tie reciprocity) suggests a lack of mutual edges compared to the asymmetric ones, but not their absence. This statement should also be contextualized considering some reference points, such as the minimum and maximum possible reciprocity values. The former refers to the absence of reciprocity, namely a network with only asymmetric (or null) edges, and assesses a reciprocity rate of $0$:

$$
R_{min} = \frac{2\cdot M}{2\cdot M+A} = \frac{2\cdot 0}{2\cdot 0+A}=0
$$

The latter instead assumes that all edges within the network are mutual. Therefore, the highest reachable value would be $1$:

$$
R_{max} = \frac{2\cdot M}{2 \cdot M+A} = \frac{2\cdot M}{2\cdot M}=1
$$
Instead, considering the dyadic measure for reciprocity, the proportion of mutual and null edges over the total, namely the sum of mutual $M$, asymmetric $A$ and null edges $N$, yields an index of `r round(sna::grecip(net, measure="dyadic"),3)`. 

$$
R_{\text{dyadic}} = \frac{M+N}{M+N+A} 
$$

```{r}
sna::grecip(net, measure="dyadic")
```

Thanks to a different interpretation of the dyads, the obtained reciprocity value is considerably higher than before. Thus, the initial assumption relies on the definition of *null* edge as a symmetric *non-relation*, implying an absence of bullying acts from both sides. The census results highlight how the null edges represent the major type of edges (i.e., $228$ over $300$), making possible to understand the high reciprocity rate.

A clear demonstration of null edges' strong influence can be driven by computing the ratio of mutuals to non-null dyads. 

$$
Reciprocity_{\text{dyadic non null}} = \frac{M}{M+A} 
$$

The index falls to `r round(sna::grecip(net, measure="dyadic.nonnull"),3)` and indicates that over the $5\%$ of the non-null dyads is mutual.

```{r}
sna::grecip(net, measure="dyadic.nonnull")
```
